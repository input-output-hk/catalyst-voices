VERSION 0.7

COPY_SRC:
    # Copy the build src using this.
    COMMAND

    # ONLY copy whats needed to build.  Not everything.
    # Note: rust-toolchain.toml was already copied when rsut was setup.
    # Minimising whats copied reduces needless cache misses.
    COPY --dir bin crates Cargo.* .

    COPY --dir ../+global-cargo-config/.cargo .cargo

builder:
    # The builder with all necessary tools and the correct rust versions.
    FROM github.com/input-output-hk/catalyst-ci/earthly/rust:t1+rustup

    DO github.com/input-output-hk/catalyst-ci/earthly/rust:t1+RUST_SETUP

    WORKDIR /build

fmt:
    # Check if the code is properly formatted.
    FROM +builder

    DO +COPY_SRC

    RUN cargo fmt --check --all



prepare-cache:
    # THIS DOES NOT WORK RELIABLY - DO NOT USE
    # Prepare the build cache
    FROM +builder
    
    DO +COPY_SRC

    RUN cargo chef prepare --recipe-path recipe.json
    SAVE ARTIFACT recipe.json

cached-builder:
    # THIS DOES NOT WORK RELIABLY - DO NOT USE
    # Our builder with all dependencies cached.
    # Using cutoff-optimization to ensure cache hit
    FROM +builder
    COPY +prepare-cache/recipe.json ./
    CACHE target
    RUN cargo chef cook --release --locked --workspace -v

build:
    # Build the service
    FROM +builder  # Note: Cached builder DOES NOT WORK and makes broken builds.
    
    DO +COPY_SRC

    RUN cargo build --release --workspace --locked; \
        build_failed=$?; \
        cargo lint; \
        lint_failed=$?; \
        cargo docs; \
        docs_failed=$?; \
        exit $(($build_failed || $lint_failed || $docs_failed))

    RUN ldd target/x86_64-unknown-linux-musl/release/cat-gateway
    RUN readelf -p .comment target/x86_64-unknown-linux-musl/release/cat-gateway
    RUN strip -v target/x86_64-unknown-linux-musl/release/cat-gateway

    SAVE ARTIFACT target/x86_64-unknown-linux-musl/doc doc
    SAVE ARTIFACT target/x86_64-unknown-linux-musl/release/cat-gateway cat-gateway

test:
    # Run rust tests.
    FROM +build

    COPY --dir .config .

    # RUN cargo nextest run --release --workspace --locked -P ci --config-file .config/nextest.toml
    RUN cargo nextest run --release --workspace --locked -P ci
