VERSION 0.8

package-schemathesis:
    FROM python:3.12-alpine3.20
    # TODO: https://github.com/input-output-hk/catalyst-voices/issues/465
    RUN apk add --no-cache gcc musl-dev
    RUN python -m pip install schemathesis==3.27.1
    RUN mkdir /results
    COPY ./hooks/hooks.py .
    VOLUME /results
    ARG openapi_spec
    ENTRYPOINT export SCHEMATHESIS_HOOKS=hooks \
                    && st run --checks all http://0.0.0.0:3030/docs/cat-gateway.json \
                    --workers=2 \
                    --wait-for-schema=120 \
                    --max-response-time=5000 \
                    --hypothesis-max-examples=1000 \
                    --data-generation-method=all \
                    --skip-deprecated-operations \
                    --force-schema-version=30 \
                    --show-trace \
                    --force-color  \
                    --junit-xml=/results/junit-report.xml \
                    --cassette-path=/results/cassette.yaml

    ARG tag="latest"
    SAVE IMAGE schemathesis:$tag

# test-fuzzer-api - Fuzzy test cat-gateway using openapi specs.
# Disabled in CI, to enable it rename to `test-fuzzer-api`.
fuzzer-api:
    FROM earthly/dind:alpine-3.19-docker-25.0.5-r0
    RUN apk update && apk add iptables-legacy # workaround for https://github.com/earthly/earthly/issues/3784
    RUN apk add yq zstd curl
    COPY schemathesis-docker-compose.yml .
    #LET OPENAPI_SPEC="http://cat-gateway:3030/docs/cat-gateway.json"

    WITH DOCKER \
        --compose schemathesis-docker-compose.yml \
        --load schemathesis:latest=(+package-schemathesis) \
        #--load event-db:latest=(../../event-db+build) \
        --load cat-gateway:latest=(+package-cat-gateway-integration) \
        #--service event-db \
        --service cat-gateway \
        --allow-privileged

        RUN sleep 120 && docker run --net=host schemathesis:latest
    END
   # WAIT
   #     SAVE ARTIFACT junit-report.xml AS LOCAL schemathesis.junit-report.xml
 #       SAVE ARTIFACT cassette.yaml AS LOCAL cassette.yaml
  #  END

package-cat-gateway-integration:
    FROM python:3.14.0a3-slim-bookworm
    ENV LOG_LEVEL=error
    ENV DATA_REFRESH_TICK=5
    ENV CHECK_CONFIG_TICK=5
    ENV MACHINE_ID="UID"
    ENV CHAIN_FOLLOWER_SYNC_TASKS="16"
    ENV RUST_LOG="error,cat_gateway=debug,cardano_chain_follower=debug,mithril-client=debug"
    ENV CHAIN_NETWORK="Preprod"
    ENV CAT_ADDRESS=0.0.0.0:3030
    ENV INTERNAL_API_KEY=123

    RUN apt-get update && apt install -y gnupg2 wget
    RUN mkdir -p /etc/apt/keyrings
    RUN gpg --homedir /tmp --no-default-keyring --keyring /etc/apt/keyrings/scylladb.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys a43e06657bac99e3
    RUN wget -O /etc/apt/sources.list.d/scylla.list http://downloads.scylladb.com/deb/debian/scylla-6.2.list
    RUN apt-get update && apt-get install -y scylla

    COPY node1-scylla.yaml /etc/scylla/scylla.yaml
    #RUN scylla_setup -y
    #https://github.com/scylladb/scylladb/issues/3142
    COPY ../../+build/cat-gateway .

    #RUN --no-cache wget -qO cargo_install https://sh.rustup.rs/ && chmod +x cargo_install && ./cargo_install -y && . "$HOME/.cargo/env" && cargo --version && pip install schemathesis==3.27.1
    #RUN mkdir /results
    #COPY ./hooks/hooks.py .
    #RUN export SCHEMATHESIS_HOOKS=hooks

    ENTRYPOINT ( scylla --options-file /etc/scylla/scylla.yaml --developer-mode 1 --default-log-level error & ) && \
         ./cat-gateway run
    SAVE IMAGE cat-gateway:latest
