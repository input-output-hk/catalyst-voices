VERSION --global-cache 0.7

builder:
    FROM github.com/input-output-hk/catalyst-ci/earthly/python:v2.10.0+python-base

    COPY --dir ./api_tests .
    DO github.com/input-output-hk/catalyst-ci/earthly/python:v2.10.0+BUILDER

preview-snapshot:
    FROM alpine:3.19

    WORKDIR /tmp

    COPY github.com/input-output-hk/catalyst-ci/earthly/mithril_snapshot:feat/mithril-snapshot+preview-snapshot/preview.tar.zst .

    # extract preview archive
    RUN apk add zstd
    RUN mkdir preview && zstd -d preview.tar.zst && tar -xf preview.tar -C ./preview
    RUN rm preview.tar && rm preview.tar.zst
    RUN ls /tmp/preview

    SAVE IMAGE preview-snapshot

test:
    FROM +builder

    ARG DB_URL="postgres://catalyst-event-dev:CHANGE_ME@event-db/CatalystEventDev"
    ARG CAT_ADDRESS="0.0.0.0:3030"

    COPY ./docker-compose.yml .

    WITH DOCKER \
        --compose docker-compose.yml \
        --load preview-snapshot=+preview-snapshot \
        --load event-db:latest=(../../event-db+build) \
        --load cat-gateway:latest=(../../+package-cat-gateway --address=$CAT_ADDRESS --db_url=$DB_URL) \
        --service cat-gateway \
        --allow-privileged
        RUN poetry run pytest || docker-compose logs cat-gateway
    END
