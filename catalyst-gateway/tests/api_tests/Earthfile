VERSION --global-cache 0.7

builder:
    FROM github.com/input-output-hk/catalyst-ci/earthly/python:v2.10.0+python-base

    # preprate tests
    COPY --dir ./api_tests .
    DO github.com/input-output-hk/catalyst-ci/earthly/python:v2.10.0+BUILDER

cat-gateway-test:
    ARG DB_URL="postgres://catalyst-event-dev:CHANGE_ME@event-db/CatalystEventDev"
    ARG CAT_ADDRESS="0.0.0.0:3030"

    FROM ../../+package-cat-gateway --address=$CAT_ADDRESS --db_url=$DB_URL

    COPY github.com/input-output-hk/catalyst-ci/earthly/mithril_snapshot:fix/mithril-preview-snapshot+package-preprod-snapshot/snapshot /tmp/preprod

    SAVE IMAGE cat-gateway-test:latest

test:
    FROM +builder

    COPY ./docker-compose.yml .

    WITH DOCKER \
        --compose docker-compose.yml \
        --load event-db:latest=(../../event-db+build) \
        --load cat-gateway-test:latest=(+cat-gateway-test) \
        --service cat-gateway \
        --allow-privileged
        RUN poetry run pytest
    END

# some-test:
#     # get event-db
#     FROM ./../../event-db+builder
#     # install poetry
#     RUN apk add poetry
#     # get cat-gateway
#     COPY ./../../+build/cat-gateway .
#     # get run script
#     COPY run.sh .
#     # get mithril preview snapshot
#     COPY github.com/input-output-hk/catalyst-ci/earthly/mithril_snapshot:fix/mithril-preview-snapshot+package-preprod-snapshot/snapshot /tmp/preprod 

#     # preprate tests
#     COPY --dir ./api_tests .
#     DO github.com/input-output-hk/catalyst-ci/earthly/python:v2.10.0+BUILDER

#     USER postgres:postgres
#     # RUN ./run.sh
#     RUN false    
