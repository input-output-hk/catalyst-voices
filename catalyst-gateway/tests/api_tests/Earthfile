VERSION 0.8

IMPORT github.com/input-output-hk/catalyst-ci/earthly/python:v3.6.14 AS python-ci
IMPORT github.com/input-output-hk/catalyst-ci/earthly/rust:v3.6.14 AS rust-ci
IMPORT github.com/input-output-hk/catalyst-storage AS cat-storage

builder:
    DO rust-ci+SETUP
    DO python-ci+INSTALL

    RUN apt-get clean && apt-get install -y git

    # prepare tests
    COPY pyproject.toml uv.lock Readme.md .
    COPY --dir ./api .
    COPY --dir ./integration .
    COPY --dir ./scripts .
    COPY --dir ./test_data .
    COPY --dir ./utils .
    COPY cat-storage+cardano-asset-preprod/cardano-asset-preprod.json .

    RUN uv sync

# Creates a package of the python integration test runner
testing-package:
    FROM +builder

    ENV ASSETS_DATA_PATH="./cardano-asset-preprod.json"

    # Install socat
    RUN apt-get clean && apt-get autoremove && apt-get update \
        && apt-get install -y --no-install-recommends socat \
        && rm -rf /var/lib/apt/lists/*

    SAVE IMAGE api-tests-runner:latest
