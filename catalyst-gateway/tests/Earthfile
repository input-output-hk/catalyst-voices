# cspell: words unittests socat

VERSION 0.8
IMPORT github.com/input-output-hk/catalyst-ci/earthly/spectral:feat/catalyst-compression-setup AS spectral-ci
IMPORT .. AS gateway

# a special package for applying migrations only up to "V2_**" migrations
package-event-db-v1:
    FROM github.com/input-output-hk/catalyst-voices/catalyst-gateway/event-db:event-db-old-signed-doc+docker

    ARG container="event-db"
    ARG tag="v1"

    COPY ./event_db_v1_seed_data ./seed

    SAVE IMAGE ${container}:${tag}

package-haproxy:
    FROM haproxy:alpine

    USER root
    RUN apk add su-exec socat
    COPY ./api_tests/utils/proxy/haproxy.cfg /usr/local/etc/haproxy/haproxy.cfg
    COPY ./api_tests/utils/proxy/haproxy_entry.sh /app/entrypoint.sh

    RUN chmod +x /app/entrypoint.sh

    ENTRYPOINT ["/app/entrypoint.sh"]
    SAVE IMAGE haproxy-node:latest

# build all necessary docker images required to run `docker-compose.yml` services
prepare-all-images:
    FROM scratch
    BUILD gateway+docker
    BUILD ../event-db+docker
    BUILD ./api_tests+package
    BUILD ./schemathesis_tests+package
    BUILD +package-rust-tests-runner
    BUILD +package-event-db-v1
    BUILD +package-haproxy

# test-lint-openapi - OpenAPI linting from an artifact
# testing whether the OpenAPI generated during build stage follows good practice.
test-lint-openapi:
    FROM spectral-ci+spectral-base
    # Copy the doc artifact.
    COPY --dir ../+build/doc .
    # Copy the spectral configuration file.
    COPY --dir ./openapi-v3.0-lints/* .
    # Scan the doc directory where type of file is JSON.
    DO spectral-ci+LINT --dir=./doc

rust-tests-builder:
    FROM gateway+builder-src

    RUN cargo nextest archive --release --archive-file cat-gateway-tests.tar.zst
    SAVE ARTIFACT . build-src-dir
    SAVE ARTIFACT cat-gateway-tests.tar.zst cat-gateway-tests.tar.zst
    SAVE ARTIFACT /usr/local/cargo/bin/cargo-nextest cargo-nextest

package-rust-tests-runner:
    FROM debian:stable-slim

    WORKDIR $HOME/build
    COPY +rust-tests-builder/build-src-dir .
    COPY +rust-tests-builder/cat-gateway-tests.tar.zst .
    COPY +rust-tests-builder/cargo-nextest .
    ENTRYPOINT ./cargo-nextest nextest run --archive-file=cat-gateway-tests.tar.zst --run-ignored=only signed_docs scylla_session scylla_queries scylla_purge rbac_index --no-fail-fast
    SAVE IMAGE rust-tests-runner:latest
