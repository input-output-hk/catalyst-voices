VERSION 0.8
IMPORT github.com/input-output-hk/catalyst-ci/earthly/spectral:v3.2.24 AS spectral-ci

package-cat-gateway-integration:
    FROM python:3.14.0a3-slim-bookworm
    ENV LOG_LEVEL=error
    ENV DATA_REFRESH_TICK=5
    ENV CHECK_CONFIG_TICK=5
    ENV MACHINE_ID="UID"
    ENV CHAIN_FOLLOWER_SYNC_TASKS="16"
    ENV RUST_LOG="error,cat_gateway=debug,cardano_chain_follower=debug,mithril-client=debug"
    ENV CHAIN_NETWORK="Preprod"
    ENV CAT_ADDRESS=0.0.0.0:3030
    ENV INTERNAL_API_KEY=123

    RUN apt-get update && apt install -y gnupg2 wget
    RUN mkdir -p /etc/apt/keyrings
    RUN gpg --homedir /tmp --no-default-keyring --keyring /etc/apt/keyrings/scylladb.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys a43e06657bac99e3
    RUN wget -O /etc/apt/sources.list.d/scylla.list http://downloads.scylladb.com/deb/debian/scylla-6.2.list
    RUN apt-get update && apt-get install -y scylla

    COPY node1-scylla.yaml /etc/scylla/scylla.yaml
    #RUN scylla_setup -y
    #https://github.com/scylladb/scylladb/issues/3142
    COPY ../+build/cat-gateway .

    ENTRYPOINT ( scylla --options-file /etc/scylla/scylla.yaml --developer-mode 1 --default-log-level error & ) && \
         ./cat-gateway run
    SAVE IMAGE cat-gateway-integration:latest

# cspell: words oapi
# test-lint-openapi - OpenAPI linting from an artifact
# testing whether the OpenAPI generated during build stage follows good practice.
test-lint-openapi:
    FROM spectral-ci+spectral-base
    # Copy the doc artifact.
    COPY --dir ../+build/doc .
    # Copy the spectral configuration file.
    COPY --dir ./openapi-v3.0-lints/* .
    # Scan the doc directory where type of file is JSON.
    DO spectral-ci+LINT --dir=./doc
