VERSION --arg-scope-and-set 0.7

deps:
    FROM ../+builder
    RUN cargo build -p cat-gateway --release
    RUN ./target/release/cat-gateway docs cat-gateway-api.json
    SAVE ARTIFACT cat-gateway-api.json cat-gateway-api.json
    SAVE ARTIFACT target/release/cat-gateway cat-gateway

fuzzer-api-test:
    FROM earthly/dind:alpine
    LET address="127.0.0.1:3030"
    LET max_examples=1
    LET max_response_time=50

    COPY +deps/cat-gateway .
    COPY integration/docker-compose.yml .

    WITH DOCKER \
        --compose docker-compose.yml \
        --pull schemathesis/schemathesis:stable \
        --load event-db:latest=(../event-db+build --with_historic_data=false) \
        --service event-db \
        --allow-privileged
        RUN --no-cache  touch ~/junit-report.xml && (./cat-gateway run \
                --address $address \
                --database-url=postgres://catalyst-event-dev:CHANGE_ME@localhost/CatalystEventDev \
                --log-level=error > cat-gateway.log &) && \
            docker run --net=host schemathesis/schemathesis:stable \
                run -E ^/api/health/started http://$address/docs/cat-gateway.json \
                     --wait-for-schema=15 --contrib-openapi-fill-missing-examples --skip-deprecated-operations \
                        --max-response-time=$max_response_time --hypothesis-max-examples=$max_examples --validate-schema=false \
                            --show-trace --junit-xml junit-report.xml && ls

    END

    SAVE ARTIFACT junit-report.xml AS LOCAL junit-report.xml
    SAVE ARTIFACT cat-gateway.log AS LOCAL cat-gateway.log

fuzzy-test:
    FROM python:3.12-alpine3.18

    # Install extra packages we will need to support plugins.
    RUN apk add --no-cache \
        curl \
        libffi-dev \
        gcc \
        musl-dev \
        libgcc
    DO github.com/earthly/lib:2.2.11+INSTALL_DIND
    RUN python -m pip install schemathesis

    LET address="127.0.0.1:3030"
    LET max_examples=1
    LET max_response_time=50

    COPY +deps/cat-gateway .
    COPY integration/docker-compose.yml .

    WITH DOCKER \
        --compose docker-compose.yml \
        --load event-db:latest=(../event-db+build --with_historic_data=false) \
        --service event-db \
        --allow-privileged
        RUN --no-cache (./cat-gateway run \
                --address $address \
                --database-url=postgres://catalyst-event-dev:CHANGE_ME@localhost/CatalystEventDev \
                --log-level=error > cat-gateway.log &) && \
              st run -E ^/api/health/started http://$address/docs/cat-gateway.json \
                     --wait-for-schema=15 --contrib-openapi-fill-missing-examples --skip-deprecated-operations \
                        --max-response-time=$max_response_time --hypothesis-max-examples=$max_examples --validate-schema=false \
                            --show-trace --junit-xml junit-report.xml && ls

    END

    SAVE ARTIFACT junit-report.xml AS LOCAL junit-report.xml
    SAVE ARTIFACT cat-gateway.log AS LOCAL cat-gateway.log


integration-test:
# Example of a setup for integration testing
    FROM ../+builder
    DO github.com/earthly/lib:2.2.11+INSTALL_DIND
    COPY +deps/cat-gateway .
    COPY integration/docker-compose.yml .
    WITH DOCKER \
        --compose docker-compose.yml \
        --load event-db:latest=(../event-db+build --with_historic_data=false) \
        --service event-db \
        --allow-privileged
        RUN (./cat-gateway run \
                --address "127.0.0.1:3030" \
                --database-url=postgres://catalyst-event-dev:CHANGE_ME@localhost/CatalystEventDev \
                --log-level=debug &) && \
            cargo llvm-cov clean --workspace && \
            cargo llvm-cov nextest --release --locked -P ci --test integration --output-path coverage-report.info
    END

    SAVE ARTIFACT target/nextest/ci/junit.xml junit-report.xml
    SAVE ARTIFACT coverage-report.info coverage-report.info
