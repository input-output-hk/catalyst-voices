name: CI nightly

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at 00:00
    - cron: '0 * * * *' # Run every hour, for testing purpose

permissions:
  id-token: write
  contents: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
    REPORT_EXT: .junit-report.xml

jobs:
  ci_nightly:
    uses: input-output-hk/catalyst-ci/.github/workflows/ci.yml@master
    with:
      aws_ecr_registry: 332405224602.dkr.ecr.eu-central-1.amazonaws.com
      aws_role_arn: arn:aws:iam::332405224602:role/ci
      aws_region: eu-central-1
      nightly: true
    secrets:
      dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
      earthly_runner_address: ${{ secrets.EARTHLY_SATELLITE_ADDRESS }}
      earthly_runner_secret: ${{ secrets.EARTHLY_RUNNER_SECRET }}

  nightly_tests:
    name: Generate test reports
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get test reports
        uses: input-output-hk/catalyst-ci/actions/run@master
        with:
          earthfile: ./catalyst_voices/
          flags:
          targets: test-unit
          target_flags:
          runner_address: ${{ secrets.EARTHLY_SATELLITE_ADDRESS }}
          artifact: "false"
      
      - name: Collect and upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
            path: '**/*${{ env.REPORT_EXT }}'
            if-no-files-found: error
            retention-days: 1