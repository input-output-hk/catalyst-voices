name: Allure Report Generation

on:
  push:

permissions:
    id-token: write
    contents: write
    packages: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    AWS_REGION: eu-central-1
    AWS_ROLE_ARN: arn:aws:iam::332405224602:role/ci
    EARTHLY_TARGET: docker
    ECR_REGISTRY: 332405224602.dkr.ecr.eu-central-1.amazonaws.com
    ALLURE_RESULTS_PATH: allure-results
    ALLURE_REPORT_PATH: docs/src/allure-report

jobs:
  generate-allure-report:
    name: Generate allure report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
            fetch-depth: 0
      - name: Setup CI
        uses: input-output-hk/catalyst-ci/actions/setup@master
        with:
            aws_role_arn: ${{ env.AWS_ROLE_ARN }}
            aws_region: ${{ env.AWS_REGION }}
            earthly_runner_secret: ${{ secrets.EARTHLY_RUNNER_SECRET }}
      - name: Get unit test report
        uses: input-output-hk/catalyst-ci/actions/run@master
        id: build
        with:
            earthfile: ./catalyst-gateway/
            flags:
            targets: build
            target_flags:
            runner_address: ${{ secrets.EARTHLY_SATELLITE_ADDRESS }}
            artifact: "false"
      - name: Setup Allure history
        run: |
              mkdir -p ${{ env.ALLURE_RESULTS_PATH }}
              cp -r ${{ env.ALLURE_REPORT_PATH }}/history ${{ env.ALLURE_RESULTS_PATH }}
              mv catalyst-gateway/cat-gateway.junit-report.xml ${{ env.ALLURE_RESULTS_PATH }}
      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        #if: always()
        with:
          allure_results: ${{ env.ALLURE_RESULTS_PATH }}
          allure_history: allure-history
          keep_reports: 5
      - name: test
        run: ls allure-history
             ls allure-report
