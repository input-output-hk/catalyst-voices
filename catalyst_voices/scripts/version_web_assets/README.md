# Web Asset Versioning

This document describes the web asset versioning system for Catalyst Voices Flutter web builds.

## Overview

The web asset versioning system automatically renames Flutter web assets with content-based MD5 hashes
to prevent browser caching issues.
This ensures users always receive the latest version of the application after deployment.

## How It Works

The `version_web_assets.dart` script:

1. Calculates MD5 hash for each auto-versioned file and renames them
   (e.g., `flutter_bootstrap.js` â†’ `flutter_bootstrap.abc12345.js`)
   * Automatically detects and versions JavaScript part files (e.g., `main.dart.js_1.part.js`)
2. Updates all asset references in HTML and JavaScript files
   * Includes updating references to part files
3. Generates a manifest file (`asset_versions.json`) with all versioned assets

### Auto-Versioned Files

The following files are automatically versioned using content-based MD5 hashes:

**Always versioned:**

* `flutter_bootstrap.js`
* `main.dart.js` (plus any part files like `main.dart.js_1.part.js`, `main.dart.js_2.part.js`, etc.)
* `canvaskit/canvaskit.wasm`
* `canvaskit/canvaskit.js`
* `canvaskit/canvaskit.js.symbols`
* `canvaskit/skwasm_heavy.wasm`
* `canvaskit/skwasm_heavy.js`
* `canvaskit/skwasm_heavy.js.symbols`
* `canvaskit/skwasm.wasm`
* `canvaskit/skwasm.js`
* `canvaskit/skwasm.js.symbols`
* `canvaskit/chromium/canvaskit.wasm`
* `canvaskit/chromium/canvaskit.js`
* `canvaskit/chromium/canvaskit.js.symbols`

**Conditionally versioned:**

* WASM-related files generated by `flutter build web --wasm` are only versioned when the `--wasm` option is set to true (default)

**Notes:**

* For large JavaScript files, Flutter may split them into multiple parts (e.g., `main.dart.js_1.part.js`, `main.dart.js_2.part.js`).
  The script automatically detects and versions all part files.
* Use `--wasm=false` when building with JS-only output (e.g., `flutter build web` without the `--wasm` flag) to skip WASM files

### Manually-Versioned Files

These files require **manual version updates** when changed because their filenames are hardcoded in Dart source code:

* `sqlite3.wasm` (in `web/` directory) - Referenced in `DatabaseConfig`
* `drift_worker.js` (in `web/` directory) - Referenced in `DatabaseConfig`
* `catalyst_key_derivation_bg.wasm` when package is rebuild rename file in `assets/js dir`
* `catalyst_compression_bg.wasm` when package is rebuild rename file in `assets/js dir`

**Why manual?**
The versioning script runs **after** `flutter build web`, but these filenames are hardcoded in Dart source code
that gets compiled **during** the build.
Therefore, the script cannot automatically update these hardcoded references.

**When to update:**
When these files change, manually rename them with a version suffix (e.g., `sqlite3.v2.wasm`) and update the references in the Dart
source code **before** running `flutter build web`.

## Usage

### Automatic (CI/CD with Earthfile)

The script runs automatically during the Earthfile `build-web` target:

```bash
earthly +build-web
```

### Manual (Local Development)

#### Option 1: Using Melos

```bash
# First, build the web app
cd apps/voices
flutter build web --release

# Then version the assets
melos run version-web-assets
```

#### Option 2: Direct Execution

```bash
# Build the web app
cd apps/voices
flutter build web --release

# Version the assets
cd ../..
dart run scripts/version_web_assets/version_web_assets.dart --build-dir=apps/voices/build/web
```

## Script Options

```bash
dart run scripts/version_web_assets.dart [options]

Options:
  -b, --build-dir     Path to the build/web directory
                      (defaults to "apps/voices/build/web")
  -v, --[no-]verbose  Enable verbose logging
                      (defaults to on)
  -w, --wasm          Include WASM files in versioning (true/false)
                      (defaults to "true")
  -h, --help          Show usage information
```

### Examples

```bash
# Version all files including main.dart.wasm (default)
dart run scripts/version_web_assets.dart
# or explicitly:
dart run scripts/version_web_assets.dart --wasm=true

# Exclude main.dart.wasm from versioning (for JS-only builds)
dart run scripts/version_web_assets.dart --wasm=false

# Custom build directory without main.dart.wasm
dart run scripts/version_web_assets.dart -b custom/path --wasm=false
```

## Output

After running the script, you'll find:

* Renamed asset files with version hashes (e.g., `flutter_bootstrap.abc12345.js`)
* Updated `index.html` with versioned filename references
* Updated asset references in JavaScript files
* Generated `asset_versions.json` manifest file in the build directory

### Example Manifest (`asset_versions.json`)

```json
{
  "generated": "2025-11-04T13:22:04.536567",
  "versioned_assets": {
    "flutter_bootstrap.js": "flutter_bootstrap.abc12345.js",
    "main.dart.js": "main.dart.def67890.js",
    "main.dart.js_1.part.js": "main.dart.js_1.part.11223344.js",
    "main.dart.js_2.part.js": "main.dart.js_2.part.55667788.js",
    "main.dart.wasm": "main.dart.123abcde.wasm",
    "canvaskit/canvaskit.wasm": "canvaskit/canvaskit.456fghij.wasm"
  },
  "asset_hashes": {
    "flutter_bootstrap.js": "abc12345",
    "main.dart.js": "def67890",
    "main.dart.js_1.part.js": "11223344",
    "main.dart.js_2.part.js": "55667788",
    "main.dart.wasm": "123abcde",
    "canvaskit/canvaskit.wasm": "456fghij"
  },
  "manually_versioned_files": [
    "sqlite3.wasm",
    "drift_worker.js",
    "catalyst_key_derivation_bg.wasm",
    "catalyst_compression_bg.wasm"
  ]
}
```

## Related Documentation

* [flutter_build_pipe](https://github.com/Vieolo/flutter_build_pipe) - Inspiration for this implementation
* [Flutter Web Cache Busting](https://docs.flutter.dev/deployment/web#caching-issues) - Flutter official docs

<!--- cspell:ignore skwasm --->
<!--- cspell:ignore fghij --->