VERSION --try --global-cache --arg-scope-and-set 0.7

deps:
    FROM debian:stable-slim
    RUN apt-get update
    RUN apt-get install -y curl git unzip bash
    WORKDIR /frontend

# Download and set-up flutter
flutter:
    FROM +deps

    RUN git clone https://github.com/flutter/flutter.git /usr/local/flutter
    ENV PATH="/usr/local/flutter/bin:/usr/local/flutter/bin/cache/dart-sdk/bin:${PATH}"

    RUN flutter channel stable
    RUN flutter upgrade
    RUN flutter --version
    RUN flutter doctor -v
    RUN flutter config --enable-web

# Build web version of Catalyst Voices
build:
    FROM +flutter

    COPY --dir pubspec.yaml lib packages web test test_driver integration_test .

    RUN flutter clean
    RUN flutter pub get
    RUN flutter build web --web-renderer canvaskit --release --target lib/configs/main_web.dart

    WORKDIR /frontend/build
    SAVE ARTIFACT web /web AS LOCAL web

docker:
    FROM +deps
    FROM nginx:stable-alpine3.17

    COPY +build/web /app
    COPY ./nginx.conf /etc/nginx/nginx.conf

    EXPOSE 80

package:
    FROM +docker

    ARG tag='latest'

    SAVE IMAGE catalyst-voices-app:$tag

test-chrome-web:
    FROM +build
    LET CHROMEDRIVER_VERSION = '114.0.5735.90'
    LET CHROME_VERSION = '114.0.5735.90-1'

    RUN apt-get update -y && apt-get install -y wget unzip xserver-xorg-video-dummy gnupg
    RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    RUN echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list
    RUN apt-get update -y
    # Install Chrome
    RUN wget --no-verbose -O /tmp/chrome.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_${CHROME_VERSION}_amd64.deb \
            && apt install -y /tmp/chrome.deb && rm /tmp/chrome.deb
    # Install Chromedriver
    LET chromedriver_dir = '/chromedriver'
    RUN mkdir $chromedriver_dir
    RUN wget -q --continue -P $chromedriver_dir "http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
    RUN unzip $chromedriver_dir/chromedriver* -d $chromedriver_dir
    ENV PATH $chromedriver_dir:$PATH

    RUN (chromedriver --port=4444 &) && \
            flutter drive --driver=test_driver/integration_test.dart \
                --target=integration_test/main.dart \
                    --flavor development -d web-server --profile --browser-name=chrome